<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mini Frontend</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { margin: 20px; }
        section { padding: 20px; border-radius: 10px; background: #ffffff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .result { white-space: pre-wrap; background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
<h1 class="mb-4">Frontend — Alumnos / Cursos / Calificaciones</h1>

<!-- ============================================================
                           ALUMNOS
=============================================================== -->
<section>
    <h2>Alumnos (SOAP - Proxy REST)</h2>

    <h4>Registrar Alumno</h4>
    <div class="row g-2">
        <div class="col"><input id="matricula" class="form-control" placeholder="Matricula"></div>
        <div class="col"><input id="curp" class="form-control" placeholder="CURP"></div>
        <div class="col"><input id="nombre" class="form-control" placeholder="Nombre"></div>
        <div class="col"><input id="apellido" class="form-control" placeholder="Apellido"></div>
        <div class="col"><input id="email" type="email" class="form-control" placeholder="Email"></div>
    </div>
    <button class="btn btn-primary mt-2" onclick="registrarAlumno()">Guardar</button>

    <h4 class="mt-4">Consultar Alumno</h4>
    <input id="buscarMatricula" class="form-control w-25" placeholder="Matricula">
    <button class="btn btn-secondary mt-2" onclick="consultarAlumno()">Buscar</button>

    <h4 class="mt-4">Editar Alumno</h4>
    <div class="row g-2">
        <div class="col"><input id="editMatricula" class="form-control" placeholder="Matricula"></div>
        <div class="col"><input id="editNombre" class="form-control" placeholder="Nuevo Nombre"></div>
        <div class="col"><input id="editApellido" class="form-control" placeholder="Nuevo Apellido"></div>
        <div class="col"><input id="editEmail" class="form-control" placeholder="Nuevo Email"></div>
        <div class="col">
            <select id="editEstatus" class="form-select">
                <option value="ACTIVO">Activo</option>
                <option value="BAJA_TEMPORAL">Baja Temporal</option>
                <option value="EGRESADO">Egresado</option>
                <option value="SUSPENDIDO">Suspendido</option>
            </select>
        </div>
    </div>
    <button class="btn btn-warning mt-2" onclick="editarAlumno()">Editar</button>

    <h4 class="mt-4">Eliminar Alumno</h4>
    <input id="deleteMatricula" class="form-control w-25" placeholder="Matricula">
    <button class="btn btn-danger mt-2" onclick="eliminarAlumno()">Eliminar</button>

    <div id="alumnosResult" class="result"></div>
</section>

<!-- ============================================================
                           CURSOS
=============================================================== -->
<section>
    <h2>Cursos (API REST)</h2>

    <h4>Registrar Curso</h4>

    <div class="row g-2">
        <div class="col-md-4"><input id="cursoNombre" class="form-control" placeholder="Nombre del curso"></div>
        <div class="col-md-4"><input id="cursoProfesor" class="form-control" placeholder="Profesor"></div>
        <div class="col-md-4"><input id="cursoDescripcion" class="form-control" placeholder="Descripción"></div>

        <div class="col-md-4">
            <label class="form-label mt-2">Fecha inicio:</label>
            <input id="cursoInicio" type="datetime-local" class="form-control">
        </div>

        <div class="col-md-4">
            <label class="form-label mt-2">Fecha fin:</label>
            <input id="cursoFin" type="datetime-local" class="form-control">
        </div>

        <div class="col-md-4">
            <label class="form-label mt-2">Horario (ej: 08:00-10:00):</label>
            <input id="cursoHorario" type="text" class="form-control" placeholder="HH:MM - HH:MM">
        </div>

        <div class="col-md-4">
            <label class="form-label mt-2">Créditos:</label>
            <input id="cursoCreditos" type="number" class="form-control" min="1" placeholder="Créditos">
        </div>

        <div class="col-md-4">
            <label class="form-label mt-2">Cupo máximo:</label>
            <input id="cursoCupo" type="number" class="form-control" min="1" placeholder="Cupo máximo">
        </div>
    </div>

    <button class="btn btn-primary mt-3" onclick="registrarCurso()">Registrar</button>

    <h4 class="mt-4">Eliminar por ID</h4>
    <input id="delCursoId" class="form-control w-25" placeholder="ID del curso">
    <button class="btn btn-danger mt-2" onclick="eliminarCursoId()">Eliminar</button>

    <h4 class="mt-4">Eliminar por Nombre</h4>
    <input id="delCursoNombre" class="form-control w-50" placeholder="Nombre del curso">
    <button class="btn btn-danger mt-2" onclick="eliminarCursoNombre()">Eliminar</button>

    <h4 class="mt-4">Eliminar por Fecha de Inicio</h4>
    <input id="delCursoFecha" type="datetime-local" class="form-control w-50">
    <button class="btn btn-danger mt-2" onclick="eliminarCursoFecha()">Eliminar</button>

    <div id="cursosResult" class="result"></div>
</section>

<!-- ============================================================
                       CALIFICACIONES
=============================================================== -->
<!-- ---------------------- CALIFICACIONES ----------------------------- -->
<section>
    <h2>Calificaciones (API REST)</h2>

    <h3>Registrar Calificación</h3>

    <input id="calMatricula" class="form-control" maxlength="20"
           placeholder="Matrícula alumno" required>

    <input id="calMateria" class="form-control"
           placeholder="Materia" required>

    <input id="calValor" type="number" class="form-control"
           placeholder="Calificación (0 a 100)"
           min="0" max="100" step="0.01" required>

    <button class="btn btn-primary mt-2" onclick="registrarCalificacion()">
        Registrar
    </button>

    <h3 class="mt-3">Ver todas</h3>
    <button class="btn btn-secondary" onclick="verCalificaciones()">Listar</button>

    <h3 class="mt-3">Ver por Alumno</h3>
    <input id="calBuscarMatricula" class="form-control"
           placeholder="Matrícula alumno">
    <button class="btn btn-info mt-2" onclick="verCalificacionesAlumno()">Buscar</button>

    <div id="calificacionesResult" class="result"></div>
</section>
</div>


<script>

    /* ------------------------- CURSOS ------------------------- */
async function registrarCurso() {

    const data = {
        nombre: cursoNombre.value.trim(),
        descripcion: cursoDescripcion.value.trim(),
        profesor: cursoProfesor.value.trim(),
        fechaInicio: cursoInicio.value,
        fechaFin: cursoFin.value,
        horario: cursoHorario.value.trim(),
        creditos: Number(cursoCreditos.value),
        cupoMaximo: Number(cursoCupo.value)
    };

    // ----- VALIDACIONES -----

    if (!data.nombre)
        return cursosResult.textContent = "El nombre del curso es obligatorio.";

    if (!data.descripcion)
        return cursosResult.textContent = "La descripción es obligatoria.";

    if (!data.profesor)
        return cursosResult.textContent = "El nombre del profesor es obligatorio.";

    if (!data.fechaInicio)
        return cursosResult.textContent = "Debes seleccionar fecha de inicio.";

    if (!data.fechaFin)
        return cursosResult.textContent = "Debes seleccionar fecha de fin.";

    const inicio = new Date(data.fechaInicio);
    const fin = new Date(data.fechaFin);

    if (isNaN(inicio.getTime()) || isNaN(fin.getTime())) {
        return cursosResult.textContent = "Las fechas no tienen formato válido.";
    }

    if (fin <= inicio) {
        return cursosResult.textContent = "La fecha de fin debe ser después de la fecha de inicio.";
    }

    if (!data.horario)
        return cursosResult.textContent = "El horario es obligatorio.";

    // Formato de horario ejemplo: "09:00-12:00"
    if (!/^\d{2}:\d{2}\-\d{2}:\d{2}$/.test(data.horario)) {
        return cursosResult.textContent =
            "El horario debe ser en formato HH:MM-HH:MM";
    }

    if (isNaN(data.creditos) || data.creditos < 1) {
        return cursosResult.textContent = "Los créditos deben ser un número mayor o igual a 1.";
    }

    if (isNaN(data.cupoMaximo) || data.cupoMaximo < 1) {
        return cursosResult.textContent = "El cupo máximo debe ser un número mayor o igual a 1.";
    }

    // ----- SI TODO ES CORRECTO -----
    send("/api/cursos", "POST", data, cursosResult);
}

async function eliminarCursoId() {
    const id = delCursoId.value.trim();
    if (!id) return cursosResult.textContent = "Ingresa un ID de curso.";
    send(`/api/cursos/${id}`, "DELETE", null, cursosResult);
}

async function eliminarCursoNombre() {
    const nombre = delCursoNombre.value.trim();
    if (!nombre) return cursosResult.textContent = "Ingresa un nombre de curso.";
    send(`/api/cursos/nombre/${nombre}`, "DELETE", null, cursosResult);
}

async function eliminarCursoFecha() {
    const fecha = delCursoFecha.value;
    if (!fecha) return cursosResult.textContent = "Selecciona una fecha válida.";
    send(`/api/cursos/fecha-inicio/${fecha}`, "DELETE", null, cursosResult);
}

/* ------------------------- ALUMNOS ------------------------- */
async function registrarAlumno() {
    const data = {
        matricula: matricula.value.trim(),
        curp: curp.value.trim(),
        nombre: nombre.value.trim(),
        apellido: apellido.value.trim(),
        email: email.value.trim()
    };

    // ----- VALIDACIONES -----
    if (!data.matricula) {
        return alumnosResult.textContent = "La matrícula es obligatoria.";
    }

    if (!data.curp || data.curp.length !== 18) {
        return alumnosResult.textContent = "La CURP debe tener exactamente 18 caracteres.";
    }

    if (!data.nombre) {
        return alumnosResult.textContent = "El nombre es obligatorio.";
    }

    if (!data.apellido) {
        return alumnosResult.textContent = "El apellido es obligatorio.";
    }

    // val email simple
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(data.email)) {
        return alumnosResult.textContent = "El email no es válido.";
    }

    send("/api/alumnos", "POST", data, alumnosResult);
}

async function consultarAlumno() {
    const m = buscarMatricula.value.trim();
    if (!m) return alumnosResult.textContent = "Debes ingresar una matrícula.";
    send(`/api/alumnos/${m}`, "GET", null, alumnosResult);
}

async function editarAlumno() {
    const data = {
        nombre: editNombre.value.trim(),
        apellido: editApellido.value.trim(),
        email: editEmail.value.trim(),
        estatus: editEstatus.value
    };

    const m = editMatricula.value.trim();
    if (!m) return alumnosResult.textContent = "Debes ingresar matrícula a editar.";

    if (!data.nombre) return alumnosResult.textContent = "El nombre es obligatorio.";
    if (!data.apellido) return alumnosResult.textContent = "El apellido es obligatorio.";

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(data.email)) {
        return alumnosResult.textContent = "Email inválido.";
    }

    send(`/api/alumnos/${m}`, "PUT", data, alumnosResult);
}

async function eliminarAlumno() {
    const m = deleteMatricula.value.trim();
    if (!m) return alumnosResult.textContent = "Ingresa la matrícula a eliminar.";
    send(`/api/alumnos/${m}`, "DELETE", null, alumnosResult);
}

/* --------------------- CALIFICACIONES --------------------- */
async function registrarCalificacion() {
    const matricula = calMatricula.value.trim();
    const materia = calMateria.value.trim();
    const valor = calValor.value.trim();

    // --- VALIDACIONES ---
    if (!matricula || matricula.length > 20) {
        return calificacionesResult.textContent =
            "Matrícula inválida (máx. 20 caracteres)";
    }

    if (!materia) {
        return calificacionesResult.textContent =
            "La materia es obligatoria.";
    }

    const num = Number(valor);
    if (isNaN(num) || num < 0 || num > 100) {
        return calificacionesResult.textContent =
            "La calificación debe ser un número entre 0 y 100.";
    }
    const data = {
        matriculaAlumno: matricula,
        materia: materia,
        calificacion: num
    };

    send("/api/calificaciones", "POST", data, calificacionesResult);
}


async function verCalificaciones() {
    send("/api/calificaciones", "GET", null, calificacionesResult);
}

async function verCalificacionesAlumno() {
    send(`/api/calificaciones/alumno/${calBuscarMatricula.value}`, "GET", null, calificacionesResult);
}

/* -------------------- FUNCION AJAX GENERAL --------------------- */
async function send(url, method, body, output) {
    try {
        const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: body ? JSON.stringify(body) : null
        });
        output.textContent = await res.text();
    } catch (e) {
        output.textContent = "Error: " + e;
    }
}
</script>

</body>
</html>
